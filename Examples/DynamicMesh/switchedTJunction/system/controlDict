/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  4.x                                   |
|   \\  /    A nd           | Web:      www.OpenFOAM.org                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/
FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    location    "system";
    object      controlDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

application     interDyMFoam;

startFrom       startTime;

startTime       0;

stopAt          endTime;

endTime         1;

deltaT          0.001;

writeControl    adjustableRunTime;

writeInterval   0.05;

purgeWrite      0;

writeFormat     ascii;

writePrecision  6;

writeCompression compressed;

timeFormat      general;

timePrecision   6;

runTimeModifiable yes;

adjustTimeStep  yes;

maxCo           1;
maxAlphaCo      1;

maxDeltaT       1;

libs (
    "libswakDynamicMesh.so"
    "libsimpleSwakFunctionObjects.so"
    "libgroovyBC.so"
    "libswakStateMachine.so"
);

functions {
    valveStates {
        type stateMachineCreateAndUpdate;
        valueType internalField;
        states (
            filling
            openLeft
            closingLeft
            openRight
        );
        machineName valves;
        initialState filling;
        aliases {
            frac alpha.water;
        }
        //        debugCommonDriver 1;
        variables (
            "filledIn{cellZone'inletBlock}=sum(vol()*frac)/sum(vol());"
            "inletFlow{inlet}=-sum(phi*frac);"
            "leftFlow{left}=sum(phi*frac);"
            "rightFlow{right}=sum(phi*frac);"
        );
        transitions (
            {
                from filling; to openLeft;
                description "Fill up inlet pipe";
                condition "filledIn>0.75"; logicalAccumulation and;
            }
            {
                from openLeft; to closingLeft;
                description "More goes out than in";
                condition "leftFlow>inletFlow"; logicalAccumulation and;
            }
            {
                from closingLeft; to openRight;
                description "Wait a little bit with the closing";
                condition "stateMachine_timeSinceChange(valves)>0.1";  logicalAccumulation or;
            }
            {
                from openRight; to filling;
                description "Wait till the inlet is almost drained";
                condition "filledIn<0.01"; logicalAccumulation or;
            }
        );
        ignore_unimplemented_simpleFunctionObject::movePoints true;
    }
    inletMachine {
        type stateMachineCreateAndUpdate;
        valueType patch;
        patchName inlet;
        states (
            fullOn
            rampDown
        );
        initialState fullOn;
        machineName theInlet;
        transitions (
            {
                from fullOn; to rampDown;
                description "Close the inlet and drain";
                condition "stateMachine_isState(valves,openRight)"; logicalAccumulation or;
            }
            {
                from rampDown; to fullOn;
                description "Switch to full again";
                condition "stateMachine_isState(valves,filling)"; logicalAccumulation or;
            }
        );
        ignore_unimplemented_simpleFunctionObject::movePoints true;
    }
    writeValveMachine {
        type stateMachineState;
        machineName valves;
        writeStartTime true;
        verbose true;
        ignore_unimplemented_simpleFunctionObject::movePoints true;
    }
    writeInletMachine {
        $writeValveMachine;
        machineName theInlet;
    }
    getTheValve {
        type readAndUpdateFields;
        fields (
            valveField
        );
    }
    inletFraction {
        type swakExpression;
        valueType cellZone;
        zoneName inletBlock;
        verbose true;
        accumulations (
            weightedAverage
        );
        aliases {
            aWater alpha.water;
        }
        expression "aWater";
        ignore_unimplemented_simpleFunctionObject::movePoints true;
    }
    centralFraction {
        $inletFraction;
        zoneName centralBlock;
    }
    leftFraction {
        $inletFraction;
        zoneName leftBlock;
    }
    rightFraction {
        $inletFraction;
        zoneName rightBlock;
    }
    leftOutFraction {
        $inletFraction;
        valueType patch;
        patchName left;
    }
    rightOutFraction {
        $leftOutFraction;
        patchName right;
    }
}

DebugSwitches {
    // groovyCyclicACMI 1;
}

// ************************************************************************* //
